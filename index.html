<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>ExiT Messenger kompakt</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #121212;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 100vh;
      color: #e0e0e0;
      user-select: none;
    }

    h2 {
      color: #bb86fc;
      margin-bottom: 15px;
      font-weight: 700;
      text-shadow: 0 0 6px #985effaa;
      letter-spacing: 1.2px;
    }

    #loginSection, #chatSection {
      background: #1f1f1f;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgb(0 0 0 / 0.9);
      padding: 15px;
      width: 100%;
      max-width: 450px;
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
    }

    #chat {
      border: 1px solid #333;
      border-radius: 6px;
      height: 300px;
      overflow-y: auto;
      padding: 10px;
      background: #181818;
      margin-bottom: 10px;
      font-size: 13px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .message {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .avatar {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      flex-shrink: 0;
      background-color: #555;
      object-fit: cover;
    }

    .message-content {
      flex-grow: 1;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 6px;
    }

    .username {
      font-weight: 700;
      color: #bb86fc;
      white-space: nowrap;
      user-select: text;
    }

    .text {
      color: #ddd;
      word-break: break-word;
      flex-shrink: 1;
    }

    .timestamp {
      font-size: 10px;
      color: #888;
      white-space: nowrap;
      user-select: none;
    }

    #loginSection input, #messageInput, #uploadInput {
      padding: 8px;
      font-size: 14px;
      border: 1px solid #333;
      border-radius: 6px;
      width: calc(100% - 18px);
      margin-bottom: 10px;
      box-sizing: border-box;
      background: #121212;
      color: #e0e0e0;
    }

    #loginBtn, #sendBtn, #reloadBtn, #logoutBtn {
      background-color: #bb86fc;
      color: #121212;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.2s ease;
      margin-left: 8px;
      white-space: nowrap;
    }

    #loginBtn:hover, #sendBtn:hover, #reloadBtn:hover, #logoutBtn:hover {
      background-color: #985eff;
    }

    #controls {
      display: flex;
      align-items: center;
      margin-top: 5px;
      flex-wrap: wrap;
      gap: 8px;
    }

    #messageInput {
      flex-grow: 1;
      min-width: 120px;
    }

    @media (max-width: 480px) {
      #messageInput {
        width: 100%;
        margin-right: 0;
        margin-bottom: 10px;
      }
      #controls {
        flex-direction: column;
        align-items: stretch;
      }
      #sendBtn, #reloadBtn, #logoutBtn {
        width: 100%;
        margin-left: 0;
        margin-bottom: 10px;
      }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

  <h2>ExiT Messenger kompakt</h2>

  <div id="loginSection">
    <input id="usernameInput" placeholder="Dein Name" autocomplete="off" />
    <input type="file" id="uploadInput" accept="image/*" title="Profilbild hochladen (optional)" />
    <button id="loginBtn">Login</button>
  </div>

  <div id="chatSection" style="display:none;">
    <div id="chat"></div>
    <div id="controls">
      <input id="messageInput" placeholder="Deine Nachricht" autocomplete="off" />
      <button id="sendBtn">Senden</button>
      <button id="reloadBtn" title="Chat manuell neu laden">Reload</button>
      <button id="logoutBtn" title="Ausloggen">Logout</button>
    </div>
  </div>

<script>
  const supabaseUrl = 'https://qyymrxhohtfqtbzshqcw.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF5eW1yeGhvaHRmcXRienNocWN3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI1Nzg3NzAsImV4cCI6MjA2ODE1NDc3MH0.nPdfLljxaMY51llMho-hsaXcscls5-ZdH09gbJ0ocbE';

  const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

  let username = null;
  let subscription = null;
  let profileImageDataUrl = null; // eigenes Profilbild als base64

  const loginSection = document.getElementById('loginSection');
  const chatSection = document.getElementById('chatSection');
  const chatDiv = document.getElementById('chat');
  const usernameInput = document.getElementById('usernameInput');
  const loginBtn = document.getElementById('loginBtn');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');
  const reloadBtn = document.getElementById('reloadBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const uploadInput = document.getElementById('uploadInput');

  // Image upload auslesen und speichern
  uploadInput.addEventListener('change', () => {
    const file = uploadInput.files[0];
    if (!file) return;

    if (!file.type.startsWith('image/')) {
      alert('Bitte nur Bilder hochladen!');
      uploadInput.value = '';
      return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
      profileImageDataUrl = e.target.result;
      // Bild lokal speichern, damit es nach Reload bleibt
      localStorage.setItem('profileImage', profileImageDataUrl);
    };
    reader.readAsDataURL(file);
  });

  logoutBtn.onclick = () => {
    localStorage.removeItem('chatUsername');
    localStorage.removeItem('profileImage');
    username = null;
    profileImageDataUrl = null;
    chatDiv.innerHTML = '';
    loginSection.style.display = 'block';
    chatSection.style.display = 'none';
    if (subscription) {
      subscription.unsubscribe();
      subscription = null;
    }
    uploadInput.value = '';
    usernameInput.value = '';
  };

  window.onload = () => {
    const savedUser = localStorage.getItem('chatUsername');
    const savedImage = localStorage.getItem('profileImage');
    if (savedUser) {
      username = savedUser;
      profileImageDataUrl = savedImage;
      loginSection.style.display = 'none';
      chatSection.style.display = 'flex';
      loadMessages();
      subscribeMessages();
    }
  };

  loginBtn.onclick = async () => {
    const name = usernameInput.value.trim();
    if (!name) return alert('Gib bitte einen Namen ein');
    username = name;
    localStorage.setItem('chatUsername', username);
    if (profileImageDataUrl) {
      localStorage.setItem('profileImage', profileImageDataUrl);
    }
    loginSection.style.display = 'none';
    chatSection.style.display = 'flex';
    await loadMessages();
    subscribeMessages();
  };

  function formatTimestamp(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
  }

  // Fallback-Profilbild (Initialen)
  function createAvatarUrl(name) {
    const encodedName = encodeURIComponent(name);
    return `https://ui-avatars.com/api/?name=${encodedName}&background=bb86fc&color=121212&rounded=true&size=64`;
  }

  async function loadMessages() {
    const { data, error } = await supabaseClient
      .from('messages')
      .select('*')
      .order('created_at', { ascending: true })
      .limit(100);

    if (error) {
      console.error('Fehler beim Laden der Nachrichten:', error);
    } else {
      chatDiv.innerHTML = '';
      data.forEach(msg => {
        addMessageToChat(msg.username, msg.content, msg.created_at);
      });
      chatDiv.scrollTop = chatDiv.scrollHeight;
    }
  }

  function subscribeMessages() {
    if (subscription) {
      subscription.unsubscribe();
    }
    subscription = supabaseClient
      .channel('public:messages')
      .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, payload => {
        const msg = payload.new;
        addMessageToChat(msg.username, msg.content, msg.created_at);
        chatDiv.scrollTop = chatDiv.scrollHeight;
      })
      .subscribe();
  }

  function addMessageToChat(usernameMsg, content, createdAt) {
    const msgDiv = document.createElement('div');
    msgDiv.classList.add('message');

    // Avatar: eigenes Bild wenn User == eigener Name und Bild gesetzt
    const avatarImg = document.createElement('img');
    avatarImg.classList.add('avatar');

    if (usernameMsg === username && profileImageDataUrl) {
      avatarImg.src = profileImageDataUrl;
    } else {
      avatarImg.src = createAvatarUrl(usernameMsg);
    }
    avatarImg.alt = usernameMsg + ' Profilbild';

    const contentDiv = document.createElement('div');
    contentDiv.classList.add('message-content');

    const userSpan = document.createElement('span');
    userSpan.classList.add('username');
    userSpan.textContent = usernameMsg;

    const msgText = document.createElement('span');
    msgText.classList.add('text');
    msgText.textContent = content;

    const timeSpan = document.createElement('span');
    timeSpan.classList.add('timestamp');
    timeSpan.textContent = formatTimestamp(createdAt);

    contentDiv.appendChild(userSpan);
    contentDiv.appendChild(msgText);
    contentDiv.appendChild(timeSpan);

    msgDiv.appendChild(avatarImg);
    msgDiv.appendChild(contentDiv);

    chatDiv.appendChild(msgDiv);
  }

  async function sendMessage() {
    const content = messageInput.value.trim();
    if (!content) return;

    const { error } = await supabaseClient
      .from('messages')
      .insert({ username, content });

    if (error) {
      console.error('Fehler beim Senden:', error);
      alert('Fehler beim Senden der Nachricht.');
    } else {
      messageInput.value = '';
    }
  }

  sendBtn.onclick = sendMessage;

  messageInput.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
      loadMessages();
    }
  });

  reloadBtn.onclick = loadMessages;
</script>

</body>
</html>
