<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Realtime Chat mit Supabase</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; max-width: 600px; }
    #chat { border: 1px solid #ccc; height: 400px; overflow-y: scroll; padding: 10px; margin-bottom: 10px; }
    #messageInput { width: 70%; }
    #sendBtn { width: 14%; }
    #refreshBtn { width: 14%; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

  <h2>Supabase Realtime Chat</h2>

  <div id="loginSection">
    <input id="usernameInput" placeholder="Dein Name" />
    <button id="loginBtn">Login</button>
  </div>

  <div id="chatSection" style="display:none;">
    <div id="chat"></div>
    <input id="messageInput" placeholder="Deine Nachricht" />
    <button id="sendBtn">Senden</button>
    <button id="refreshBtn">Aktualisieren</button>
  </div>

<script>
  // Hier deine Supabase-URL und dein Public Anon Key einfügen:
  const supabaseUrl = 'https://qyymrxhohtfqtbzshqcw.supabase.co'    // z.B. https://abcd1234.supabase.co
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF5eW1yeGhvaHRmcXRienNocWN3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI1Nzg3NzAsImV4cCI6MjA2ODE1NDc3MH0.nPdfLljxaMY51llMho-hsaXcscls5-ZdH09gbJ0ocbE' 

  // Supabase Client initialisieren
  const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey)

  let username = null

  const loginSection = document.getElementById('loginSection')
  const chatSection = document.getElementById('chatSection')
  const chatDiv = document.getElementById('chat')
  const usernameInput = document.getElementById('usernameInput')
  const loginBtn = document.getElementById('loginBtn')
  const messageInput = document.getElementById('messageInput')
  const sendBtn = document.getElementById('sendBtn')
  const refreshBtn = document.getElementById('refreshBtn')

  loginBtn.onclick = async () => {
    const name = usernameInput.value.trim()
    if(!name) return alert('Gib bitte einen Namen ein')
    username = name
    loginSection.style.display = 'none'
    chatSection.style.display = 'block'
    await loadMessages()
    await subscribeMessages()
  }

  // Alle Nachrichten laden
  async function loadMessages() {
    const { data, error } = await supabaseClient
      .from('messages')
      .select('*')
      .order('created_at', { ascending: true })
      .limit(100)

    if(error) {
      console.error('Fehler beim Laden der Nachrichten:', error)
    } else {
      chatDiv.innerHTML = ''
      data.forEach(msg => {
        addMessageToChat(msg.username, msg.content)
      })
      chatDiv.scrollTop = chatDiv.scrollHeight
    }
  }

  // Echtzeit abonnieren, neue Nachrichten anzeigen
  async function subscribeMessages() {
    const channel = supabaseClient
      .channel('public:messages')
      .on(
        'postgres_changes', 
        { event: 'INSERT', schema: 'public', table: 'messages' },
        (payload) => {
          const msg = payload.new
          // Verhindere doppelte Nachrichten von dir selbst (optional)
          if(msg.username !== username) {
            addMessageToChat(msg.username, msg.content)
          }
        }
      )
    const { error } = await channel.subscribe()
    if(error) {
      console.error('Subscription error:', error)
    } else {
      console.log('Subscription erfolgreich!')
    }
  }

  // Automatisches Nachladen alle 30 Sekunden (30000 ms)
setInterval(() => {
  console.log('Automatischer Reload läuft...')
  loadMessages()
}, 100)


  // Neue Nachricht ins Chatfenster schreiben
  function addMessageToChat(user, text) {
    const el = document.createElement('div')
    el.textContent = `${user}: ${text}`
    chatDiv.appendChild(el)
    chatDiv.scrollTop = chatDiv.scrollHeight
  }

  // Nachricht senden
  sendBtn.onclick = async () => {
    const text = messageInput.value.trim()
    if(!text) return
    const { data, error } = await supabaseClient
      .from('messages')
      .insert([{ username, content: text }])
    
    if(error) {
      console.error('Fehler beim Senden:', error)
    } else {
      // Eigene Nachricht direkt anzeigen
      addMessageToChat(username, text)
      messageInput.value = ''
    }
  }

  // Enter-Taste zum Senden benutzen
  messageInput.addEventListener('keypress', e => {
    if(e.key === 'Enter') sendBtn.click()
  })

  // Manuelles Aktualisieren
  refreshBtn.onclick = loadMessages

</script>

</body>
</html>
