<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Chat Login</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #1e1e1e;
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }

    #loginSection, #chatSection {
      background: #2a2a2a;
      padding: 20px;
      border-radius: 12px;
      width: 320px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    input, button {
      padding: 10px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
    }

    input {
      background: #444;
      color: #fff;
    }

    button {
      background: #007bff;
      color: #fff;
      cursor: pointer;
      transition: 0.2s;
    }

    button:hover {
      background: #0056b3;
    }

    #chatSection {
      display: none;
    }

    #chatDiv {
      background: #111;
      height: 200px;
      overflow-y: auto;
      padding: 10px;
      border-radius: 8px;
    }

    .message {
      margin-bottom: 8px;
      padding: 6px;
      background: #333;
      border-radius: 6px;
    }

    /* Einstellungen Popup */
    #settingsPopup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #222;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
    }

    #settingsPopup img {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  
  <!-- LOGIN SECTION -->
  <div id="loginSection">
    <h2>Login</h2>
    <input id="usernameInput" placeholder="Dein Name (max. 15 Zeichen)" maxlength="15" autocomplete="off" />
    <input id="passwordInput" type="password" placeholder="Passwort" autocomplete="off" />
    <button id="loginBtn">Login</button>
  </div>

  <!-- CHAT SECTION -->
  <div id="chatSection">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h2>Chat</h2>
      <img id="profileImageDisplay" src="" alt="Profil" style="width:40px;height:40px;border-radius:50%;object-fit:cover;">
    </div>
    <div id="chatDiv"></div>
    <input id="msgInput" placeholder="Nachricht..." />
    <button id="sendBtn">Senden</button>
    <div style="display:flex;justify-content:space-between;margin-top:10px;">
      <button id="settingsBtn">‚öôÔ∏è Einstellungen</button>
      <button id="logoutBtn" style="background: red;">Logout</button>
    </div>
  </div>

  <!-- Einstellungen Popup -->
  <div id="settingsPopup">
    <h3>Einstellungen</h3>
    <img id="currentProfileImage" src="" alt="Profilbild">
    <input type="file" id="uploadInput" accept="image/*">
    <br><br>
    <button id="closeSettings">Schlie√üen</button>
  </div>

  <script>
    const loginSection = document.getElementById('loginSection');
    const chatSection = document.getElementById('chatSection');
    const usernameInput = document.getElementById('usernameInput');
    const passwordInput = document.getElementById('passwordInput');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const chatDiv = document.getElementById('chatDiv');
    const msgInput = document.getElementById('msgInput');
    const sendBtn = document.getElementById('sendBtn');

    const profileImageDisplay = document.getElementById('profileImageDisplay');
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsPopup = document.getElementById('settingsPopup');
    const currentProfileImage = document.getElementById('currentProfileImage');
    const uploadInput = document.getElementById('uploadInput');
    const closeSettings = document.getElementById('closeSettings');

    let username = null;
    let subscription = null;

    // Login-Button
    loginBtn.onclick = async () => {
      const name = usernameInput.value.trim();
      const pass = passwordInput.value.trim();

      if (!name) return alert('Gib bitte einen Namen ein.');
      if (name.length > 15) return alert('Der Name darf max. 15 Zeichen haben.');
      if (!pass) return alert('Bitte ein Passwort eingeben.');

      const savedUser = localStorage.getItem('chatUsername');
      const savedPass = localStorage.getItem('chatPassword');

      if (savedUser && savedPass) {
        // Account existiert schon -> Passwort checken
        if (name !== savedUser) {
          return alert('Dieser Benutzername ist nicht registriert.');
        }
        if (pass !== savedPass) {
          return alert('Falsches Passwort!');
        }
      } else {
        // Neuer Account -> speichern
        localStorage.setItem('chatUsername', name);
        localStorage.setItem('chatPassword', pass);
      }

      username = name;
      loginSection.style.display = 'none';
      chatSection.style.display = 'flex';

      loadProfileImage();
      await loadMessages();
      subscribeMessages();
    };

    // Logout-Button
    logoutBtn.onclick = () => {
      localStorage.removeItem('chatUsername');
      localStorage.removeItem('chatPassword');
      localStorage.removeItem('profileImage');

      username = null;
      chatDiv.innerHTML = '';
      loginSection.style.display = 'block';
      chatSection.style.display = 'none';

      if (subscription) {
        clearInterval(subscription);
        subscription = null;
      }

      usernameInput.value = '';
      passwordInput.value = '';
      profileImageDisplay.src = '';
    };

    // Nachrichten laden
    async function loadMessages() {
      chatDiv.innerHTML = '';
      const fakeMessages = [
        { user: "System", text: "Willkommen im Chat!" },
        { user: "Bot", text: "Sag hallo üëã" }
      ];
      fakeMessages.forEach(msg => {
        const div = document.createElement('div');
        div.classList.add('message');
        div.textContent = `${msg.user}: ${msg.text}`;
        chatDiv.appendChild(div);
      });
    }

    // Fake Realtime
    function subscribeMessages() {
      subscription = setInterval(() => {
        const div = document.createElement('div');
        div.classList.add('message');
        div.textContent = "Bot: Random Nachricht ü§ñ";
        chatDiv.appendChild(div);
        chatDiv.scrollTop = chatDiv.scrollHeight;
      }, 5000);
    }

    // Nachricht senden
    sendBtn.onclick = () => {
      const text = msgInput.value.trim();
      if (!text) return;
      const div = document.createElement('div');
      div.classList.add('message');
      div.textContent = `${username}: ${text}`;
      chatDiv.appendChild(div);
      chatDiv.scrollTop = chatDiv.scrollHeight;
      msgInput.value = '';
    };

    // Einstellungen √∂ffnen
    settingsBtn.onclick = () => {
      settingsPopup.style.display = 'block';
      loadProfileImageInPopup();
    };

    closeSettings.onclick = () => {
      settingsPopup.style.display = 'none';
    };

    // Profilbild hochladen in Einstellungen
    uploadInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (event) => {
          const imgData = event.target.result;
          localStorage.setItem('profileImage', imgData);
          loadProfileImage();
          loadProfileImageInPopup();
        };
        reader.readAsDataURL(file);
      }
    });

    function loadProfileImage() {
      const savedImg = localStorage.getItem('profileImage');
      if (savedImg) {
        profileImageDisplay.src = savedImg;
      } else {
        profileImageDisplay.src = "https://via.placeholder.com/40x40?text=üë§";
      }
    }

    function loadProfileImageInPopup() {
      const savedImg = localStorage.getItem('profileImage');
      currentProfileImage.src = savedImg || "https://via.placeholder.com/80x80?text=üë§";
    }

    // Auto-Login
    window.onload = () => {
      const savedUser = localStorage.getItem('chatUsername');
      const savedPass = localStorage.getItem('chatPassword');

      if (savedUser && savedPass) {
        username = savedUser;
        loginSection.style.display = 'none';
        chatSection.style.display = 'flex';
        loadProfileImage();
        loadMessages();
        subscribeMessages();
      }
    };
  </script>

</body>
</html>
