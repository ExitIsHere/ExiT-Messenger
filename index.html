<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>ExiT Messenger</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #121212;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 100vh;
      color: #e0e0e0;
    }

    h2 {
      color: #bb86fc;
      margin-bottom: 15px;
      text-shadow: 0 0 6px #985effaa;
    }

    #loginSection, #chatSection {
      background: #1f1f1f;
      border-radius: 10px;
      padding: 15px;
      width: 100%;
      max-width: 450px;
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
    }

    #chat {
      border: 1px solid #333;
      border-radius: 6px;
      height: 300px;
      overflow-y: auto;
      padding: 10px;
      background: #181818;
      margin-bottom: 10px;
      font-size: 13px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .message {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .avatar {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      flex-shrink: 0;
      background-color: #555;
      object-fit: cover;
    }

    .message-content {
      flex-grow: 1;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 6px;
    }

    .username {
      font-weight: 700;
      color: #bb86fc;
      white-space: nowrap;
    }

    .text {
      color: #ddd;
      word-break: break-word;
    }

    .timestamp {
      font-size: 10px;
      color: #888;
      white-space: nowrap;
    }

    input {
      padding: 8px;
      font-size: 14px;
      border: 1px solid #333;
      border-radius: 6px;
      width: calc(100% - 16px);
      margin-bottom: 10px;
      background: #121212;
      color: #e0e0e0;
    }

    button {
      background-color: #bb86fc;
      color: #121212;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.2s ease;
      margin-top: 5px;
    }
    button:hover {
      background-color: #985eff;
    }

    #controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #messageInput {
      flex-grow: 1;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <h2>ExiT Messenger</h2>

  <!-- LOGIN SECTION -->
  <div id="loginSection">
    <input id="usernameInput" placeholder="Dein Name (max 15 Zeichen)" maxlength="15" />
    <input type="password" id="passwordInput" placeholder="Passwort" />
    <button id="loginBtn">Login / Registrieren</button>
  </div>

  <!-- CHAT SECTION -->
  <div id="chatSection" style="display:none;">
    <div id="chat"></div>
    <div id="controls">
      <input id="messageInput" placeholder="Deine Nachricht" />
      <button id="sendBtn">Senden</button>
      <button id="reloadBtn">Reload</button>
      <button id="logoutBtn">Logout</button>
    </div>
  </div>

<script>
  const supabaseUrl = 'https://qyymrxhohtfqtbzshqcw.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF5eW1yeGhvaHRmcXRienNocWN3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI1Nzg3NzAsImV4cCI6MjA2ODE1NDc3MH0.nPdfLljxaMY51llMho-hsaXcscls5-ZdH09gbJ0ocbE';
  const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

  let username = null;
  let subscription = null;

  const loginSection = document.getElementById('loginSection');
  const chatSection = document.getElementById('chatSection');
  const chatDiv = document.getElementById('chat');

  const usernameInput = document.getElementById('usernameInput');
  const passwordInput = document.getElementById('passwordInput');
  const loginBtn = document.getElementById('loginBtn');

  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');
  const reloadBtn = document.getElementById('reloadBtn');
  const logoutBtn = document.getElementById('logoutBtn');

  // --- Login / Register ---
  loginBtn.onclick = async () => {
    const name = usernameInput.value.trim();
    const pass = passwordInput.value.trim();

    if (!name || !pass) return alert("Bitte Name + Passwort eingeben!");
    if (name.length > 15) return alert("Name darf max. 15 Zeichen haben!");

    // Check ob User schon existiert
    let { data: existingUsers, error } = await supabaseClient
      .from('users')
      .select('*')
      .eq('username', name)
      .limit(1);

    if (error) {
      console.error(error);
      return alert("Fehler beim Abrufen der Userdaten");
    }

    if (existingUsers.length === 0) {
      // Registrieren
      const { error: insertErr } = await supabaseClient
        .from('users')
        .insert([{ username: name, password: pass }]);
      if (insertErr) {
        console.error(insertErr);
        return alert("Fehler beim Registrieren");
      }
      alert("✅ Neuer Account erstellt!");
    } else {
      // Einloggen => Passwort prüfen
      const user = existingUsers[0];
      if (user.password !== pass) {
        return alert("❌ Passwort falsch!");
      }
    }

    // Login ok -> speichern
    username = name;
    localStorage.setItem("chatUsername", username);

    loginSection.style.display = 'none';
    chatSection.style.display = 'flex';

    await loadMessages();
    subscribeMessages();
  };

  // --- Logout ---
  logoutBtn.onclick = () => {
    localStorage.removeItem('chatUsername');
    username = null;
    chatDiv.innerHTML = '';
    loginSection.style.display = 'block';
    chatSection.style.display = 'none';
    if (subscription) subscription.unsubscribe();
  };

  // --- Auto-Login falls gespeichert ---
  window.onload = async () => {
    const saved = localStorage.getItem('chatUsername');
    if (saved) {
      username = saved;
      loginSection.style.display = 'none';
      chatSection.style.display = 'flex';
      await loadMessages();
      subscribeMessages();
    }
  };

  // --- Nachrichten laden ---
  async function loadMessages() {
    const { data, error } = await supabaseClient
      .from('messages')
      .select('*')
      .order('created_at', { ascending: true })
      .limit(100);

    if (error) {
      console.error('Fehler beim Laden:', error);
      return;
    }
    chatDiv.innerHTML = '';
    data.forEach(msg => addMessageToChat(msg.username, msg.content, msg.created_at));
    chatDiv.scrollTop = chatDiv.scrollHeight;
  }

  function subscribeMessages() {
    if (subscription) subscription.unsubscribe();

    subscription = supabaseClient
      .channel('public:messages')
      .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, payload => {
        const msg = payload.new;
        addMessageToChat(msg.username, msg.content, msg.created_at);
        chatDiv.scrollTop = chatDiv.scrollHeight;
      })
      .subscribe();
  }

  function formatTimestamp(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
  }

  function createAvatarUrl(name) {
    const encoded = encodeURIComponent(name);
    return `https://ui-avatars.com/api/?name=${encoded}&background=bb86fc&color=121212&rounded=true&size=64`;
  }

  function addMessageToChat(usernameMsg, content, createdAt) {
    const msgDiv = document.createElement('div');
    msgDiv.classList.add('message');

    const avatarImg = document.createElement('img');
    avatarImg.classList.add('avatar');
    avatarImg.src = createAvatarUrl(usernameMsg);

    const contentDiv = document.createElement('div');
    contentDiv.classList.add('message-content');

    const userSpan = document.createElement('span');
    userSpan.classList.add('username');
    userSpan.textContent = usernameMsg;

    const msgText = document.createElement('span');
    msgText.classList.add('text');
    msgText.textContent = content;

    const timeSpan = document.createElement('span');
    timeSpan.classList.add('timestamp');
    timeSpan.textContent = formatTimestamp(createdAt);

    contentDiv.append(userSpan, msgText, timeSpan);
    msgDiv.append(avatarImg, contentDiv);
    chatDiv.appendChild(msgDiv);
  }

  // --- Nachricht senden ---
  async function sendMessage() {
    const content = messageInput.value.trim();
    if (!content) return;
    const { error } = await supabaseClient
      .from('messages')
      .insert([{ username, content }]);
    if (error) {
      console.error(error);
      alert("Fehler beim Senden");
    } else {
      messageInput.value = '';
    }
  }

  sendBtn.onclick = sendMessage;
  messageInput.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  reloadBtn.onclick = loadMessages;
</script>

</body>
</html>
